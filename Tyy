from google.cloud import monitoring_v3
import pandas as pd
import datetime

client = monitoring_v3.MetricServiceClient()
project_name = "projects/YOUR_PROJECT_ID"

now = datetime.datetime.utcnow()
past = now - datetime.timedelta(days=14)

interval = monitoring_v3.TimeInterval(
    end_time={"seconds": int(now.timestamp())},
    start_time={"seconds": int(past.timestamp())},
)

query = 'metric.type="compute.googleapis.com/instance/cpu/utilization"'
results = client.list_time_series(
    request={
        "name": project_name,
        "filter": query,
        "interval": interval,
        "view": monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL,
    }
)

rows = []
for result in results:
    for point in result.points:
        ts = point.interval.end_time.timestamp()
        value = point.value.double_value
        rows.append({"timestamp": ts, "cpu": value})

df = pd.DataFrame(rows).sort_values("timestamp")
df.to_csv("cpu_history.csv", index=False)
print(df.tail())