from github import Github
import csv

# Replace 'your_github_token' with your personal access token for GitHub Enterprise
GITHUB_TOKEN = 'your_github_token'
GITHUB_ENTERPRISE_URL = 'https://almgithub.uk.bcp/api/v3'  # GitHub Enterprise API URL
ORG_NAME = 'ihub-infrastructure'
SEARCH_TERM = 'efx'
CSV_FILE = 'efx_occurrences.csv'

# Initialize Github instance with the provided token and Enterprise URL
g = Github(base_url=GITHUB_ENTERPRISE_URL, login_or_token=GITHUB_TOKEN)

def list_repositories(org_name):
    """Lists all repositories in the specified GitHub organization."""
    org = g.get_organization(org_name)
    return org.get_repos()

def search_term_in_repo(repo, search_term):
    """Searches for a specific term in all files of a given repository."""
    try:
        contents = repo.get_contents("")
        all_files = []
        while contents:
            file_content = contents.pop(0)
            if file_content.type == "dir":
                contents.extend(repo.get_contents(file_content.path))
            else:
                if search_term in file_content.decoded_content.decode():
                    all_files.append(file_content.path)
        return all_files
    except Exception as e:
        print(f"Error searching in repo {repo.name}: {str(e)}")
        return []

def get_last_committer(repo, file_path):
    """Gets the last committer for a specified file in a repository."""
    try:
        commits = repo.get_commits(path=file_path)
        if commits.totalCount > 0:
            return commits[0].commit.committer.name
        return None
    except Exception as e:
        print(f"Error fetching commits for file {file_path} in repo {repo.name}: {str(e)}")
        return None

def main():
    """Main function to gather data and write to a CSV file."""
    all_data = []
    repositories = list_repositories(ORG_NAME)
    
    for repo in repositories:
        print(f"Searching in repository: {repo.name}")
        search_results = search_term_in_repo(repo, SEARCH_TERM)
        for file_path in search_results:
            last_committer = get_last_committer(repo, file_path)
            all_data.append([repo.name, file_path, last_committer])
    
    # Write data to CSV
    with open(CSV_FILE, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Repository", "File Path", "Last Committer"])
        writer.writerows(all_data)
    
    print(f"Data has been written to {CSV_FILE}")

if __name__ == "__main__":
    main()
